<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="description" content="Neuronum empowers Businesses to Build, Deploy & Automate Economic Data Streams">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="max-image-preview: none">
  <title>Enter Cellkey</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/static/favicon.png" />
  <link rel="stylesheet" href="/static/mobile_design.css">
  <link rel="stylesheet" href="/static/tablet_design.css">
  <link rel="stylesheet" href="/static/desktop_design.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>

  <body class="pageContainer">

   <div class="socials desktop">
      <a href="https://www.github.com/neuronumcybernetics" target="_blank"><i class="fa-brands fa-github"></i></a>&nbsp;
    </div>
  

      <div class="connectContainer">
        <div class="cellKey">
          <div class="txTitle">CELL KEY</div>
          <div class="placeTransmitterLogoSmall"><img src="/static/logo.png" class="transmitterLogoSmall"></div>
          <div class="txID">send to <span id="email"></span></div>

          <form id="validateCellKeyForm" method="post" enctype="multipart/form-data">
            <div class="keyInputContainer"> 
              <input class="connectInput" id="cellKey" name="cellKey" style="color: white;" placeholder="enter cell key" required>
            </div>
            <button type="submit" id="validateCellKey" class="uploadButton">validate</button>
          </form>
      </div>
   

   <div class="footerContainer">
      <div class="fixedFooter">
        <a href="/"><img src="/static/logo.png" alt="Neuronum Logo - A Cyber Neuron" class="headerLogo" ></a>
        <a class="footerMail" href="mailto:welcome@neuronum.net">welcome@neuronum.net</a>
      </div>
    </div>

    <script>
  window.onload = function () {
      const email = localStorage.getItem('email');
      if (email) {
          document.getElementById('email').textContent = email;
      } else {
          document.getElementById('email').textContent = 'no mail';
      }
  };

  document.getElementById('validateCellKeyForm').addEventListener('submit', async function(e) {
    e.preventDefault(); // Prevent the default form submission
    const cellKey = document.getElementById('cellKey').value.trim();
    const email = localStorage.getItem('email');
    const host = localStorage.getItem('host');

    if (!cellKey) {
        alert("Please enter the cell key.");
        return;
    }

    if (!email || !host) {
        alert("Missing email or host information.");
        return;
    }

    try {
        const response = await fetch('https://neuronum.net/api/verify_email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                host: host,
                email: email,
                cellkey: cellKey,
                browser: true
            })
        });

        if (response.ok) {
        const result = await response.json();
        console.log('Verification successful:', result);

        if (result.session) {
            localStorage.setItem('session', result.session);
        }
        if (result.synapse) {
            localStorage.setItem('synapse', result.synapse);
        }

              // Generate key pair using Web Crypto API for ECDH
        const keyPair = await window.crypto.subtle.generateKey(
            {
                name: "ECDH",
                namedCurve: "P-256",
            },
            true, // extractable
            ["deriveKey", "deriveBits"] // key usages for ECDH
        );

        // Export keys to JSON Web Key (JWK) format for storage
        const privateKeyJwk = await window.crypto.subtle.exportKey("jwk", keyPair.privateKey);
        const publicKeyJwk = await window.crypto.subtle.exportKey("jwk", keyPair.publicKey);

        // Store in localStorage (you can also use IndexedDB for more secure storage)
        localStorage.setItem('privateKey', JSON.stringify(privateKeyJwk));
        localStorage.setItem('publicKey', JSON.stringify(publicKeyJwk));

        // Redirect after successful login and key generation
        window.location.href = '/neuronum_cellai';
            } else {
                const error = await response.json();
                console.error('Verification failed:', error);
                alert(error.message || "Verification failed. Please check your cell key.");
            }
        } catch (err) {
            console.error("Error submitting form:", err);
            alert("An error occurred while verifying the cell key.");
        }
    });

</script>


  </body>
</html>
